name: Deploy to Play Store Internal Testing

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - 'app/**'
      - 'version.properties'
      - '.github/workflows/internal-release.yml'

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_FILE }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > $GITHUB_WORKSPACE/release.jks
          
      - name: Create keystore.properties
        run: |
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > keystore.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> keystore.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> keystore.properties
          echo "storeFile=$GITHUB_WORKSPACE/release.jks" >> keystore.properties
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Calculate Dynamic Version
        id: version
        run: |
          BASE_VERSION_CODE=$(grep "versionCode=" version.properties | cut -d'=' -f2)
          BASE_VERSION_NAME=$(grep "versionName=" version.properties | cut -d'=' -f2)
          VERSION_CODE=$((BASE_VERSION_CODE + ${{ github.run_number }}))
          VERSION_NAME="${BASE_VERSION_NAME}.${{ github.run_number }}"
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          
      - name: Build Release AAB
        run: ./gradlew bundleRelease
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          APP_VERSION_CODE: ${{ steps.version.outputs.version_code }}
          APP_VERSION_NAME: ${{ steps.version.outputs.version_name }}
          
      - name: Upload to Play Store Internal Testing
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.karnadigital.vyoma.atlas
          releaseFiles: app/build/outputs/bundle/release/app-release.aab
          track: internal
          status: completed
          whatsNewDirectory: distribution
          
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ steps.version.outputs.version_name }}
          path: app/build/outputs/bundle/release/app-release.aab
          retention-days: 30
      

          
      - name: Notify success
        if: success()
        run: |
          echo "âœ… Successfully deployed version ${{ steps.version.outputs.version_name }} (code: ${{ steps.version.outputs.version_code }}) to Play Store Internal Testing!"
